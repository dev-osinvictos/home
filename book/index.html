<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coach Appointment Payment & Booking</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  
  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- üîπ Garante firebase no escopo global ANTES dos m√≥dulos -->
  <script>
  window.globalThis.firebase = firebase;
  </script>

<!-- Supabase + Firebase config injection corrigida -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

try {
  console.log("üåê Buscando configura√ß√£o do backend...");
  const configRes = await fetch("https://coachappoint.onrender.com/config", {
    method: "GET",
    headers: { "Content-Type": "application/json" },
  });

  if (!configRes.ok) {
    throw new Error(`Erro ao carregar config: ${configRes.status}`);
  }

  const { firebaseConfig, supabaseConfig } = await configRes.json();
  console.log("‚úÖ Config carregada com sucesso:", { firebaseConfig, supabaseConfig });

  // üîπ Armazena o Firebase config globalmente
  window.__firebase_config = firebaseConfig;

  // üîπ Inicializa Supabase globalmente
  const SUPABASE_URL = supabaseConfig.supabaseUrl;
  const SUPABASE_ANON_KEY = supabaseConfig.supabaseKey;

  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.error("‚ùå Supabase configuration missing");
  } else {
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("‚úÖ Supabase client initialized:", SUPABASE_URL);
  }

  // üîπ Fun√ß√£o global de upload de arquivo para Supabase
  window.uploadBookingFile = async (file, userId) => {
    if (!file) {
      console.warn("Nenhum arquivo selecionado.");
      return null;
    }

    const safeUserId = userId || "anonymous";
    const path = `${safeUserId}/${Date.now()}_${file.name}`;

    console.log("üì§ Enviando para Supabase:", {
      bucket: "bookings",
      path,
      fileName: file.name,
      sizeKB: (file.size / 1024).toFixed(1),
      type: file.type,
    });

    try {
      const { data, error } = await window.supabase.storage
        .from("bookings")
        .upload(path, file);

      if (error) {
        console.error("‚ùå Supabase upload failed:", error);
        alert(`Upload falhou: ${error.message}`);
        return null;
      }

      const publicURL = `${SUPABASE_URL}/storage/v1/object/public/bookings/${path}`;
      console.log("‚úÖ Upload conclu√≠do:", publicURL);
      return publicURL;
    } catch (e) {
      console.error("üî• Erro inesperado no upload:", e);
      alert(`Erro inesperado: ${e.message}`);
      return null;
    }
  };

} catch (e) {
  console.error("üö® Falha ao inicializar configura√ß√£o remota:", e);
  alert("Erro ao conectar com o servidor. Veja o console para mais detalhes.");
}
</script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; background-image: url('../assets/background-image.jpg'); background-repeat: no-repeat; background-size: cover;}
    .card { box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s; }
    .card:hover { transform: translateY(-2px); }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

  <!-- Main Booking Card -->
  <div class="card w-full max-w-md bg-white p-8 rounded-xl border border-gray-200">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">Agende p/ Interagir em<br> Campo T√°tico Interativo<br></h1>

    <div id="status-display" class="mb-6 p-4 rounded-lg text-center font-medium" role="status">
      Please connect your Ethereum wallet.
    </div>

    <div id="connection-info" class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg hidden">
      <p class="text-sm font-semibold text-indigo-700">Wallet Connected:</p>
      <p id="account-display" class="text-sm font-mono text-indigo-900 truncate mt-1"></p>
      <p class="text-sm font-semibold text-indigo-700 mt-2">Cost:</p>
      <p class="text-lg font-bold text-indigo-900" id="cost-display">0.00001 BTC</p>
    </div>

    <div class="mb-4">
      <label for="appointment-slot" class="block text-sm font-medium text-gray-700 mb-2">
        Treinadores dispon√≠veis:
      </label>
      <select id="appointment-slot" class="w-full p-3 border border-gray-300 rounded-lg bg-white" disabled>
        <option value="" disabled selected>-- Treinadores em Disponibilidade --</option>
        <option value="J. Mourinho, Seg-10am (Oct 28)">J. Mourinho, Segunda, Oct 28 -10:00AM)</option>
        <option value="Tite, Qua-2pm (Oct 30)">Tite, Wednesday, Oct 30 (14:00 UTC)</option>
        <option value="M. Costa -Sex, 4pm UTC (Nov 1)">M. Costa, Nov 1 (16:00 UTC)</option>
      </select>
    </div>

    <!-- üÜï File Upload -->
    <div class="mb-4">
      <label for="booking-file" class="block text-sm font-medium text-gray-700 mb-2">
        Optional: Anexe nota ou "screenshot" (para o Treinador)
      </label>
      <input type="file" id="booking-file"
        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white" />
    </div>

    <div class="space-y-4">
      <button id="connect-btn"
        class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">Conecte Carteira Web 3.0</button>
      <button id="book-btn"
        class="w-full py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 hidden"
        onclick="bookAppointment()" disabled>Pay 0.00001 BTC e Agenda definida</button>
    </div>

    <div id="loading-spinner" class="mt-6 text-center hidden">
      <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-indigo-500 border-r-transparent"></div>
      <p class="text-indigo-600 mt-2 font-medium">Processando Transa√ß√£o...</p>
    </div>
  </div>

  <script>
    const { ethers } = window;

  // üîß Garante que a config do Firebase seja carregada antes do uso
  function waitForFirebaseConfig(timeoutMs = 5000) {
    const start = Date.now();
    return new Promise((resolve) => {
      const check = () => {
        if (window.__firebase_config || Date.now() - start > timeoutMs) {
          resolve(window.__firebase_config || null);
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    });
  }

waitForFirebaseConfig().then(firebaseConfig => {
  if (!firebaseConfig) {
    console.error("‚ùå Firebase config not injected by server.");
  } else {
    console.log("üî• Firebase config detected late:", firebaseConfig);
  }

  // üîπ Make token global
  window.initialAuthToken =
    typeof window.__initial_auth_token !== 'undefined'
      ? window.__initial_auth_token
      : null;
});
    // --- Constants ---
    const COACH_ADDRESS = "0x8e843477103e3a968b4b335352358f5b12a45a62";
    const SEPOLIA_CHAIN_ID = 11155111;
    const APPOINTMENT_COST_ETH = 0.00001;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // --- DOM Elements ---
    const statusDisplay = document.getElementById('status-display');
    const connectBtn = document.getElementById('connect-btn');
    const bookBtn = document.getElementById('book-btn');
    const accountDisplay = document.getElementById('account-display');
    const connectionInfo = document.getElementById('connection-info');
    const loadingSpinner = document.getElementById('loading-spinner');
    const appointmentSlot = document.getElementById('appointment-slot');

    let provider, signer, db, auth, userId;

    function updateStatus(text, type='info') {
      statusDisplay.textContent = text;
      statusDisplay.className = 'mb-6 p-4 rounded-lg text-center font-medium';
      const colors = { success:'bg-green-100 text-green-800', error:'bg-red-100 text-red-800', warning:'bg-yellow-100 text-yellow-800', info:'bg-blue-100 text-blue-800' };
      statusDisplay.classList.add(...colors[type].split(' '));
    }

    async function checkNetwork(network) {
      const currentChainId = Number(network.chainId);
      if (currentChainId !== SEPOLIA_CHAIN_ID) {
        updateStatus("Por favor troque a carteira para BTC.", 'warning');
        bookBtn.disabled = true;
        return false;
      }
      updateStatus("Carteira Web 3.0 com Bitcoin. Pronto para Agendar.", 'info');
      appointmentSlot.disabled = false;
      bookBtn.disabled = appointmentSlot.value === "";
      return true;
    }

    console.log("üîç Firebase global available:", !!window.firebase);

    async function initializeFirebaseAndAuth() {
    const firebaseConfig = window.__firebase_config;
    if (!window.firebase || !firebaseConfig) {
      console.error("Firebase SDK or config missing.");
      updateStatus("Firebase config missing. Check server injection.", 'error');
      return false;
    }

  try {
      const app = window.firebase.initializeApp(firebaseConfig);
      db = window.firebase.firestore(app);
      auth = window.firebase.auth(app);
      window.firebase.firestore.setLogLevel('debug');

    let credential;

  if (window.initialAuthToken && window.initialAuthToken !== "null") {
  credential = await auth.signInWithCustomToken(window.initialAuthToken);
} else {
  credential = await auth.signInAnonymously();
}

    // üîπ Espera garantir que o usu√°rio esteja definido
    await new Promise((resolve) => {
      auth.onAuthStateChanged((user) => {
        if (user) {
          userId = user.uid;
          console.log("‚úÖ Firebase Auth success:", userId);
          resolve();
        }
      });
    });

    return true;
  } catch (e) {
    console.error("‚ùå Firebase initialization or auth failed:", e);
    updateStatus("Firebase init/auth failed: " + e.message, 'error');
    return false;
  }
}


    async function connectWallet() {
      if (!window.ethereum) {
        updateStatus("Carteira Web 3.0 inexistente. Por favor instale MetaMask Wallet.", 'error');
        return;
      }
      try {
        connectBtn.disabled = true;
        updateStatus("Conectando Carteira Web 3.0...", 'info');

        // ‚úÖ Aguarda Firebase estar pronto antes de prosseguir
        const firebaseReady = await initializeFirebaseAndAuth();
        if (!firebaseReady) {
          updateStatus("Firebase initialization failed.", "error");
          connectBtn.disabled = false;
          return;
        }

        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        const network = await provider.getNetwork();
        const account = await signer.getAddress();
        connectBtn.classList.add('hidden');
        bookBtn.classList.remove('hidden');
        connectionInfo.classList.remove('hidden');
        accountDisplay.textContent = account;

        window.ethereum.on('chainChanged', () => window.location.reload());
        await checkNetwork(network);
      } catch (e) {
        console.error("Wallet connect failed:", e);
        connectBtn.disabled = false;
        updateStatus("Connection failed: " + e.message, 'error');
      }
    }

async function saveBooking(payerAddress, txHash, selectedSlot, fileURL = null) {
  const bookingData = {
    payerAddress,
    coachAddress: COACH_ADDRESS,
    appointmentTime: selectedSlot,
    costEth: APPOINTMENT_COST_ETH,
    transactionHash: txHash,
    fileURL,
    timestamp: new Date().toISOString(),
  };

  try {
    console.log("üíæ Enviando booking para backend:", bookingData);

    const response = await fetch("https://coachappoint.onrender.com/saveBooking", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bookingData),
    });

    const result = await response.json();

    if (result.success) {
      console.log("‚úÖ Booking salvo com sucesso no servidor:", result.id);
      alert("‚úÖ Booking confirmado com sucesso!");
      return true;
    } else {
      console.error("‚ùå Falha ao salvar booking:", result.error);
      alert("Falha ao salvar booking. Veja o console para detalhes.");
      return false;
    }
  } catch (e) {
    console.error("üî• Erro ao enviar booking para servidor:", e);
    alert("Erro ao salvar booking. Veja o console para detalhes.");
    return false;
  }
}
 // üîπ Upload de arquivo para Supabase Storage
  window.uploadBookingFile = async function (file, userId) {
    try {
      if (!window.supabase) {
        console.error("‚ùå Supabase not initialized");
        return null;
      }

      const fileExt = file.name.split('.').pop();
      const filePath = `bookings/${userId}/${Date.now()}.${fileExt}`;

      const { data, error } = await window.supabase.storage
        .from('bookings') // nome do seu bucket
        .upload(filePath, file, {
          contentType: file.type,
        });

      if (error) throw error;

      console.log("‚úÖ File uploaded to Supabase:", data.path);

      const { data: publicData } = window.supabase.storage
        .from('bookings')
        .getPublicUrl(data.path);

      return publicData.publicUrl;
    } catch (e) {
      console.error("‚ùå Error uploading file:", e);
      return null;
    }
  };

  async function bookAppointment() {
    const slot = appointmentSlot.value;
    if (!signer || !slot)
      return updateStatus("Wallet not connected or slot missing.", "error");

    const payerAddress = await signer.getAddress();
    bookBtn.disabled = true;
    appointmentSlot.disabled = true;
    loadingSpinner.classList.remove("hidden");
    updateStatus(`Booking ${slot}... Confirm in your wallet.`, "warning");

    try {
      const tx = await signer.sendTransaction({
        to: COACH_ADDRESS,
        value: ethers.parseEther(APPOINTMENT_COST_ETH.toString()),
      });

      updateStatus(`Transaction sent. Waiting for confirmation...`, "warning");
      const receipt = await tx.wait();
      loadingSpinner.classList.add("hidden");

      if (receipt && receipt.status === 1) {
        // üÜï Upload optional file to Supabase
        const file = document.getElementById("booking-file").files[0];
        let fileURL = null;
        const safeUserId = userId || "anonymous"; // fallback

        if (file) {
          updateStatus("Uploading file to Supabase...", "info");
          fileURL = await window.uploadBookingFile(file, safeUserId);
        }

        const saved = await saveBooking(payerAddress, receipt.hash, slot, fileURL);
        const msg = saved
          ? "Booking saved successfully."
          : "Payment succeeded but booking not saved.";
        updateStatus(`üéâ SUCCESS! ${msg} Tx: ${receipt.hash}`, "success");
      } else {
        updateStatus("Transaction failed on blockchain.", "error");
        bookBtn.disabled = false;
        appointmentSlot.disabled = false;
      }
    } catch (e) {
      console.error("Payment error:", e);
      loadingSpinner.classList.add("hidden");
      bookBtn.disabled = false;
      appointmentSlot.disabled = false;
      const msg =
        e.code === "ACTION_REJECTED"
          ? "Transaction rejected by user."
          : e.message.includes("insufficient funds")
          ? "Insufficient funds."
          : `Payment failed: ${e.message}`;
      updateStatus(msg, "error");
    }
  }

    window.onload = () => {
      document.getElementById("connect-btn").addEventListener("click", connectWallet);
      document.getElementById('cost-display').textContent = `${APPOINTMENT_COST_ETH} Sepolia ETH`;
      document.getElementById('book-btn').textContent = `Pay ${APPOINTMENT_COST_ETH} ETH and Book Appointment`;
      updateStatus(window.ethereum ? "MetaMask detected. Click Connect Wallet to begin." : "Install MetaMask to continue.", window.ethereum ? 'info' : 'error');
      appointmentSlot.addEventListener('change', () => { bookBtn.disabled = !(signer && appointmentSlot.value); });
    };
  </script>
</body>
</html>
